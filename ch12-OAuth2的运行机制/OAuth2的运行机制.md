# OAuth2是什么

OAuth2被称为**授权框架**，其主要目的是**允许第三方网站或应用程序访问资源**

> 第三方：本系统需要以某一身份访问另一个访问资源，且不管理另一个系统的用户内容

OAuth2不是一个特定的实现或库，与语言毫无关系

# 统一授权

多个服务的授权处理通过一个授权服务器实现

<img src=".OAuth2%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.assets/image-20220523152553196.png" alt="image-20220523152553196" style="zoom:67%;" />





# OAuth2组件

+ **资源服务器**：托管用户所拥有资源的应用程序

+ **用户**：资源所有者，页面交互者

+ **客户端**：以用户的名义访问用户所拥有资源的应用程序（使用客户端ID和客户端密钥标识自己）

  **客户端指的是需要通过授权的，获取资源的一方**

+ **授权服务器**：授权客户端访问由资源服务器（授予客户端令牌访问资源服务器的资源）

重要思想：

+ 用户和客户端是不同主体（客户端实际操作不一定是用户的意愿）

+ 对于这两个实体，**OAuth2的作用是保证客户端，在用户的允许下，以用户的身份安全地访问对应资源**（如下图的第二、三个箭头）





# OAuth2实现选项

## 客户端凭据是什么

它们的共同目标都是为了让客户端获取到资源访问令牌

## 授权码

### 基本流程

<img src=".OAuth2%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.assets/image-20220523161032922.png" alt="image-20220523161032922" style="zoom:67%;" />

### 重要步骤

#### 发出身份验证请求

此过程中用户直接和权限认证服务器进行交互，不会经过客户端（直接和授权服务器交互）

##### 请求内容

+ repsponse_type设为需返回认证码，告知授权服务器要返回认证码认证码
+ client_id 和 client_secret：标识客户端
+ redirect_uri：认证成功的跳转uri
+ scope：权限
+ state：csrf令牌



#### 获取访问令牌

客户端和权限认证服务器的交互（不需要用户进行任何行为）

##### 请求内容

+ code
+ client_id 和 client_secret
+ redirect_uri
+ grant_type:authorization_code 用于标识当前以code的方式获取令牌

由上述方式即可获取到一个令牌	



## 密码

**场景：客户端web应用程序和授权服务器属于同一组织构建**，

（即反过来说，对于同一组织而言，却要像认证码这种重定向认证页面的方式来进行授权认证，对于用户而言太过唐突）

<img src=".OAuth2%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.assets/image-20220523164852115.png" alt="image-20220523164852115" style="zoom:67%;" />

### 请求一个访问令牌

##### 请求内容

+ grant_type：password_code
+ client_id和client_secrete
+ scope
+ username和password

由上述方式即可获取到一个令牌	



## 上述两者的区别

+ 实现不同

  + 授权码：想要从授权服务器获取令牌，需要先经过用户获取到用户的认可，认可之后再客户端才可通过code进行后序令牌获取

  + 密码：用户直接将身份凭据交给客户端向授权服务器获取令牌

+ 场景不同：授权码往往使用于获取第三方的数据，密码往往则是访问的客户端和授权服务器是同一组织构建

+ 安全：授权码的安全大于密码，**因为密码是将凭据直接交给客户端去向授权服务器获取令牌**，所以优先考虑授权码模式



## 客户端凭据

等同于密码模式中，将API Key当作账户密码

### 请求访问令牌

+ grant_type:client_credential_code
+ client_id和client_secret
+ scope

通过该请求方式，向授权服务器请求以获取令牌



## 刷新令牌

+ 场景：用于在设定令牌的有效期时，在令牌过期后，**避免**授权码方式的重定向**登录**和密码方式的**登录**，更是**避免了在客户端对用户凭据的存储**

+ 原因：我们不可能将令牌的时间设定为无限久，这是出于安全考虑的，如果令牌的有效期是无限久，那么令牌的效果地位和凭据类似了
+ 获取的方式：只有**授权码、密码、刷新令牌**方式后会获取一个**访问令牌和刷新令牌**，客户端凭据是没有刷新令牌的

<img src=".OAuth2%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.assets/image-20220523172347256.png" alt="image-20220523172347256" style="zoom:67%;" />

### 请求内容

+ grant_type:refresh_token
+ client_id和client_secret
+ scope
+ refresh_token（在之前授权时获取到的）



# OAuth2的弱点

+ 会受到CSRF的攻击
+ 窃取客户端凭据
+ **重放**令牌（令牌被窃取后反复用于访问资源）
+ 令牌劫持

